name: Runner Terminal
on: [workflow_dispatch, push]
jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        bitness: [32, 64]
        architecture: ['lib', 'libarm'] #lib is x86, libarm is ARM
        baseLibrary: ['msvcrt', 'ucrt']
    defaults:
      run:
        shell: C:\msys64\msys2_shell.cmd -mingw64 -defterm -no-start -c "source $(cygpath '{0}')"
    outputs:
      version: ${{ steps.version.outputs.version}}
    steps:
      - name: Create directories
        run: |
          mkdir /d/a/MinGW
          mkdir /d/a/release
      - name: Clone MinGW & checkout latest version
        id: version
        run: |
          cd /d/a/MinGW
          git clone https://github.com/mirror/mingw-w64.git .
          version=$(git describe --tags `git rev-list --tags --max-count=1`)
          git checkout tags/${version} -b master
          echo "::set-output name=version::${version}"
        shell: bash
      - name: Build headers
        run: |
          cd /d/a/MinGW/mingw-w64-headers
          ./configure \
            --prefix="/d/a/release/" \
            --enable-${{ matrix.architecture }}${{ matrix.bitness }}
            --enable-experimental \
            --with-default-msvcrt=${{ matrix.baseLibrary }} \
            --enable-wildcard
          make install
      - name: Configure runtime
        run: |
          cd /d/a/MinGW/mingw-w64-crt
          ./configure \
            --prefix="/d/a/release/" \
            --enable-${{ matrix.architecture }}${{ matrix.bitness }}
            --enable-experimental \
            --with-default-msvcrt=${{ matrix.baseLibrary }} \
            --enable-wildcard
      - name: Build runtime
        run: |
          cd /d/a/MinGW/mingw-w64-crt
          make CFLAGS="-w"
      - name: Strip & install runtime
        run: |
          cd /d/a/MinGW/mingw-w64-crt
          make install-strip
      - name: Create artifact x86
        if: matrix.architecture == "lib"
        uses: actions/upload-artifact@v2
        with:
          name: Win-Open-C-Runtime-Win-x86-${{ matrix.bitness}}
          path: D:\a\release\
      - name: Create artifact ARM
        if: matrix.architecture == "libarm"
        uses: actions/upload-artifact@v2
        with:
          name: Win-Open-C-Runtime-ARM-${{ matrix.bitness }}
          path: D:\a\release\
  release:
    needs: build
    runs-on: windows-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
      - name: Create release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: '${{ secrets.GITHUB_TOKEN }}'
          prerelease: false
          title: Windows-Open-C-Runtime-${{ needs.build.outputs.version }}
          files: '*'
